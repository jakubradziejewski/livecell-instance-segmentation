services:
  training:
    build:
      context: .
      dockerfile: Dockerfile
    image: livecell-instance-segmentation:latest
    container_name: livecell_training 
    volumes:
      - ./:/workspace
      - ./data:/workspace/data
      - ./models:/workspace/models
      - ./experiments:/workspace/experiments
      # Add cache volumes for faster rebuilds
      - pip-cache:/root/.cache/pip
      - wandb-cache:/root/.cache/wandb
    runtime: nvidia
    ports:
      - "8080:8080" 
    env_file:
      - .env
    
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONPATH=/workspace
      - PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:128
      - WANDB_API_KEY=${WANDB_API_KEY}
      - WANDB_ENTITY=${WANDB_ENTITY}
      - WANDB_PROJECT=${WANDB_PROJECT}
    
    shm_size: '8gb'  # Increased for larger batch sizes with DataLoader workers
    stdin_open: true
    tty: true
    command: tail -f /dev/null

# Define named volumes for caching
volumes:
  pip-cache:
  wandb-cache: